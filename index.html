<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Smoke Less">
    <meta name="description" content="Track your cigarette reduction journey">
    <link rel="manifest" id="manifest-link">
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle fill='%23667eea' cx='50' cy='50' r='50'/%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle'%3Eüö≠%3C/text%3E%3C/svg%3E">
    <title>Smoke Less Journey</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #5568d3;
            --secondary: #764ba2;
            --accent: #f093fb;
            --accent-end: #f5576c;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;

            --bg-start: #0f172a;
            --bg-end: #1e1b4b;
            --card-bg: rgba(30, 41, 59, 0.95);
            --card-border: rgba(255, 255, 255, 0.1);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --header-bg: rgba(15, 23, 42, 0.95);
            --footer-bg: rgba(15, 23, 42, 0.95);

            --glow-primary: rgba(102, 126, 234, 0.5);
            --glow-accent: rgba(245, 87, 108, 0.5);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: var(--text-primary);
            padding-bottom: 80px;
            transition: all 0.3s ease;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--header-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 20px;
            text-align: center;
            z-index: 100;
            border-bottom: 1px solid var(--card-border);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            font-size: 1.5em;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
            filter: drop-shadow(0 0 20px var(--glow-primary));
        }

        .header p {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .hamburger-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 45px;
            height: 45px;
            border-radius: 12px;
            background: var(--card-bg);
            border: 2px solid var(--card-border);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 102;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.3s ease;
        }

        .hamburger-btn span {
            width: 20px;
            height: 2px;
            background: var(--text-primary);
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .hamburger-btn.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .hamburger-btn.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger-btn.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -7px);
        }

        .side-menu {
            position: fixed;
            top: 0;
            right: -100%;
            width: 280px;
            height: 100vh;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-left: 1px solid var(--card-border);
            box-shadow: -4px 0 30px rgba(0, 0, 0, 0.5);
            z-index: 101;
            transition: right 0.3s ease;
            overflow-y: auto;
            padding: 80px 20px 20px;
        }

        .side-menu.active {
            right: 0;
        }

        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .menu-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .menu-item {
            padding: 15px;
            margin: 10px 0;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            border: 1px solid var(--card-border);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-primary);
        }

        .menu-item:active {
            transform: scale(0.98);
        }

        .menu-item:hover {
            background: rgba(102, 126, 234, 0.2);
            box-shadow: 0 4px 15px var(--glow-primary);
        }

        .menu-item-icon {
            font-size: 1.3em;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 100px 20px 20px;
        }

        .card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--card-border);
            transition: all 0.3s ease;
        }

        .progress-ring {
            width: 200px;
            height: 200px;
            margin: 20px auto;
            position: relative;
            filter: drop-shadow(0 0 30px var(--glow-primary));
        }

        .progress-ring svg {
            transform: rotate(-90deg);
        }

        .progress-ring circle {
            fill: none;
            stroke-width: 12;
        }

        .progress-ring .bg {
            stroke: rgba(102, 126, 234, 0.2);
        }

        .progress-ring .progress {
            stroke: url(#gradient);
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
            filter: drop-shadow(0 0 10px var(--glow-primary));
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .progress-text .number {
            font-size: 3em;
            font-weight: bold;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .progress-text .label {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .countdown-timer {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .time-unit {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 20px;
            border-radius: 16px;
            min-width: 80px;
            box-shadow: 0 8px 20px var(--glow-primary);
            transition: all 0.3s ease;
        }

        .time-unit .number {
            font-size: 2.5em;
            font-weight: bold;
            display: block;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .time-unit .label {
            font-size: 0.8em;
            opacity: 0.9;
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .next-smoke {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-end) 100%);
            color: white;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 8px 25px var(--glow-accent);
        }

        .next-smoke h3 {
            font-size: 1.1em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.95;
        }

        .next-smoke .time {
            font-size: 3em;
            font-weight: bold;
            text-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .stat-box {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid var(--card-border);
            transition: all 0.3s ease;
        }

        .stat-box .value {
            font-size: 2em;
            font-weight: bold;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            transition: all 0.3s ease;
        }

        .stat-box .label {
            color: var(--text-secondary);
            margin-top: 8px;
            font-size: 0.85em;
        }

        .phase-info {
            background: linear-gradient(135deg, rgba(251, 146, 60, 0.15) 0%, rgba(249, 115, 22, 0.15) 100%);
            padding: 20px;
            border-radius: 16px;
            margin: 20px 0;
            border: 1px solid rgba(251, 146, 60, 0.3);
        }

        .phase-info h3 {
            color: var(--warning);
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .phase-info p {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .schedule-list {
            margin-top: 15px;
        }

        .schedule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            border-radius: 12px;
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
        }

        .schedule-item.completed {
            opacity: 0.6;
            border-left-color: var(--success);
        }

        .schedule-item.current {
            background: linear-gradient(135deg, rgba(245, 87, 108, 0.15) 0%, rgba(240, 147, 251, 0.15) 100%);
            border-left-color: var(--accent-end);
            box-shadow: 0 4px 15px var(--glow-accent);
        }

        .schedule-time {
            font-weight: bold;
            font-size: 1.1em;
            color: var(--primary);
        }

        .btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 16px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .motivational {
            background: linear-gradient(135deg, rgba(168, 237, 234, 0.2) 0%, rgba(254, 214, 227, 0.2) 100%);
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            margin: 20px 0;
            border: 1px solid var(--card-border);
        }

        .motivational p {
            font-size: 1.15em;
            color: var(--text-primary);
            font-style: italic;
            line-height: 1.6;
        }

        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--footer-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 15px 20px;
            text-align: center;
            border-top: 1px solid var(--card-border);
            box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.3);
            z-index: 90;
        }

        .footer p {
            color: var(--text-secondary);
            font-size: 0.85em;
        }

        .notification-banner {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.4);
        }

        .notification-banner button {
            background: white;
            color: var(--warning);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 200;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 24px;
            max-width: 500px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--card-border);
        }

        .modal-content h2 {
            margin-bottom: 25px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.8em;
        }

        .setting-group {
            margin: 25px 0;
        }

        .setting-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: var(--text-primary);
        }

        .setting-group input {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--card-border);
            border-radius: 12px;
            font-size: 1em;
            background: rgba(102, 126, 234, 0.05);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .setting-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 20px var(--glow-primary);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancel {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            border: 2px solid var(--danger);
        }

        .btn-save {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            box-shadow: 0 4px 15px var(--glow-primary);
        }

        .schedule-editor-item {
            display: flex;
            gap: 10px;
            margin: 12px 0;
            align-items: center;
        }

        .schedule-editor-item input {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--card-border);
            border-radius: 10px;
            background: rgba(102, 126, 234, 0.05);
            color: var(--text-primary);
        }

        .schedule-editor-item button {
            padding: 12px 16px;
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }

        .add-time-btn {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            font-weight: bold;
        }

        .phase-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        .phase-selector button {
            padding: 10px 16px;
            border: 2px solid var(--primary);
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary);
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        .phase-selector button.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            box-shadow: 0 4px 15px var(--glow-primary);
        }

        .install-prompt {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 8px 25px var(--glow-primary);
            display: none;
        }

        .install-prompt button {
            background: white;
            color: var(--primary);
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 12px;
        }

        @media (max-width: 600px) {
            .time-unit {
                min-width: 70px;
                padding: 15px;
            }

            .time-unit .number {
                font-size: 2em;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>üö≠ Smoke Less Journey</h1>
        <p>Your path to freedom starts here</p>
    </div>

    <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleMenu()">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>

    <div class="side-menu" id="sideMenu">
        <div class="menu-item" onclick="openSettings()">
            <span class="menu-item-icon">‚öôÔ∏è</span>
            <span>Settings</span>
        </div>
        <div class="menu-item" onclick="openScheduleEditor()">
            <span class="menu-item-icon">üìÖ</span>
            <span>Edit Schedules</span>
        </div>
        <div class="menu-item" onclick="openDayPicker()">
            <span class="menu-item-icon">üóìÔ∏è</span>
            <span>Jump to Day/Phase</span>
        </div>
        <div class="menu-item" onclick="showStats()">
            <span class="menu-item-icon">üìä</span>
            <span>Statistics</span>
        </div>
        <div class="menu-item" onclick="resetProgress()">
            <span class="menu-item-icon">üîÑ</span>
            <span>Reset Progress</span>
        </div>
        <div class="menu-item" onclick="showHelp()">
            <span class="menu-item-icon">‚ùì</span>
            <span>Help & Info</span>
        </div>
    </div>

    <div class="container">
        <div id="installPrompt" class="install-prompt">
            <p><strong>üì± Install this app</strong></p>
            <p style="font-size: 0.9em; margin-top: 8px;">Get notifications and quick access from your home screen</p>
            <button onclick="installApp()">Install Now</button>
        </div>

        <div id="notificationPrompt" class="notification-banner" style="display: none;">
            <p><strong>üîî Enable Notifications</strong></p>
            <p style="font-size: 0.9em; margin-top: 8px;">Get reminders for your smoking schedule</p>
            <button onclick="requestNotificationPermission()">Enable Notifications</button>
        </div>

        <div class="card">
            <div class="progress-ring">
                <svg width="200" height="200">
                    <defs>
                        <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#f093fb;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle class="bg" cx="100" cy="100" r="90"></circle>
                    <circle class="progress" cx="100" cy="100" r="90" id="progressCircle"></circle>
                </svg>
                <div class="progress-text">
                    <div class="number" id="dayNumber">1</div>
                    <div class="label">Day of 62</div>
                </div>
            </div>

            <div class="next-smoke">
                <h3>Next Cigarette</h3>
                <div class="time" id="nextTime">08:30</div>
            </div>

            <div class="countdown-timer">
                <div class="time-unit">
                    <span class="number" id="hours">00</span>
                    <span class="label">Hours</span>
                </div>
                <div class="time-unit">
                    <span class="number" id="minutes">00</span>
                    <span class="label">Min</span>
                </div>
                <div class="time-unit">
                    <span class="number" id="seconds">00</span>
                    <span class="label">Sec</span>
                </div>
            </div>

            <button class="btn btn-success" onclick="markSmoked()">‚úì I Smoked This One</button>
        </div>

        <div class="card">
            <div class="stats">
                <div class="stat-box">
                    <div class="value" id="todayCount">0/10</div>
                    <div class="label">Today's Progress</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="totalCost">39 DH</div>
                    <div class="label">Total Spent</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="savedMoney">0 DH</div>
                    <div class="label">Money Saved</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="totalSmoked">0</div>
                    <div class="label">Total Smoked</div>
                </div>
            </div>
        </div>

        <div class="phase-info">
            <h3 id="phaseTitle">Phase 1: Starting Strong</h3>
            <p id="phaseDesc">10 cigarettes per day for 2 days. You're building discipline!</p>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 15px; color: var(--text-primary);">üìÖ Today's Schedule</h3>
            <div class="schedule-list" id="scheduleList"></div>
        </div>

        <div class="motivational">
            <p id="motivationalText">"Every cigarette you don't smoke is a victory!"</p>
        </div>
    </div>

    <div class="footer">
        <p>üí™ Stay strong ‚Ä¢ You're doing great ‚Ä¢ Keep going!</p>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h2>‚öôÔ∏è Settings</h2>

            <div class="setting-group">
                <label>üí∞ Pack Price (DH)</label>
                <input type="number" id="packPriceInput" value="39" min="1" step="0.5">
            </div>

            <div class="setting-group">
                <label>üö¨ Cigarettes per Pack</label>
                <input type="number" id="cigarettesPerPackInput" value="20" min="1">
            </div>

            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeModal('settingsModal')">Cancel</button>
                <button class="btn-save" onclick="saveSettings()">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <h2>üìÖ Edit Schedules</h2>

            <div class="phase-selector" id="phaseSelector"></div>
            <div id="scheduleEditor"></div>

            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeModal('scheduleModal')">Cancel</button>
                <button class="btn-save" onclick="saveSchedules()">Save Schedules</button>
            </div>
        </div>
    </div>

    <div id="dayPickerModal" class="modal">
        <div class="modal-content">
            <h2>üóìÔ∏è Jump to Day/Phase</h2>

            <div class="setting-group">
                <label>Select Method</label>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="showDayInput()" style="flex: 1;">By Day Number</button>
                    <button class="btn btn-primary" onclick="showPhaseInput()" style="flex: 1;">By Phase</button>
                </div>
            </div>

            <div id="dayInputSection" style="display: none;">
                <div class="setting-group">
                    <label>üìÜ Choose Day (1-62)</label>
                    <input type="number" id="dayNumberInput" min="1" max="62" value="1">
                    <p style="color: var(--text-secondary); font-size: 0.85em; margin-top: 8px;">
                        Current day: <strong id="currentDayDisplay">1</strong>
                    </p>
                </div>
            </div>

            <div id="phaseInputSection" style="display: none;">
                <div class="setting-group">
                    <label>üìã Choose Phase</label>
                    <select id="phaseSelectInput"
                        style="width: 100%; padding: 14px; border: 2px solid var(--card-border); border-radius: 12px; font-size: 1em; background: rgba(102, 126, 234, 0.05); color: var(--text-primary);">
                    </select>
                </div>
                <div class="setting-group">
                    <label>üìÖ Day within Phase</label>
                    <input type="number" id="phasesDayInput" min="1" value="1">
                    <p style="color: var(--text-secondary); font-size: 0.85em; margin-top: 8px;">
                        Phase duration: <strong id="phaseDurationDisplay">2</strong> days
                    </p>
                </div>
            </div>

            <div class="setting-group"
                style="background: rgba(245, 158, 11, 0.1); padding: 15px; border-radius: 12px; border: 1px solid var(--warning);">
                <p style="color: var(--warning); font-size: 0.9em;">
                    ‚ö†Ô∏è <strong>Warning:</strong> Jumping to a different day will adjust your start date and may affect
                    your progress tracking. Today's count will be preserved.
                </p>
            </div>

            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeModal('dayPickerModal')">Cancel</button>
                <button class="btn-save" onclick="jumpToSelectedDay()">Jump to Day</button>
            </div>
        </div>
    </div>

    <script>
        let deferredPrompt;
        let currentEditingPhase = 0;
        let countdownInterval = null;
        let notificationCheckInterval = null;
        let wakeLock = null;
        let audioContext = null;

        // Audio notification backup
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playNotificationSound() {
            if (!audioContext) return;

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = 800;
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);

            // Play 3 beeps
            setTimeout(() => {
                const osc2 = audioContext.createOscillator();
                const gain2 = audioContext.createGain();
                osc2.connect(gain2);
                gain2.connect(audioContext.destination);
                osc2.frequency.value = 1000;
                osc2.type = 'sine';
                gain2.gain.setValueAtTime(0.3, audioContext.currentTime);
                gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                osc2.start(audioContext.currentTime);
                osc2.stop(audioContext.currentTime + 0.5);
            }, 200);

            setTimeout(() => {
                const osc3 = audioContext.createOscillator();
                const gain3 = audioContext.createGain();
                osc3.connect(gain3);
                gain3.connect(audioContext.destination);
                osc3.frequency.value = 1200;
                osc3.type = 'sine';
                gain3.gain.setValueAtTime(0.3, audioContext.currentTime);
                gain3.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                osc3.start(audioContext.currentTime);
                osc3.stop(audioContext.currentTime + 0.5);
            }, 400);
        }

        // Request wake lock to prevent sleep
        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock acquired');

                    wakeLock.addEventListener('release', () => {
                        console.log('Wake Lock released');
                    });
                } catch (err) {
                    console.error('Wake Lock error:', err);
                }
            }
        }

        // Re-acquire wake lock when page becomes visible
        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'visible' && wakeLock !== null) {
                await requestWakeLock();
            }
        });

        const defaultPhases = [
            { name: "Phase 1", perDay: 10, days: 2, times: ["08:30", "10:06", "11:42", "13:18", "14:54", "16:30", "18:06", "19:42", "21:18", "22:54"] },
            { name: "Phase 2", perDay: 5, days: 4, times: ["08:30", "12:30", "16:30", "20:30", "00:30"] },
            { name: "Phase 3", perDay: 4, days: 5, times: ["08:30", "13:50", "19:10", "00:30"] },
            { name: "Phase 4", perDay: 4, days: 5, times: ["08:30", "13:50", "19:10", "00:30"] },
            { name: "Phase 5a", perDay: 3, days: 4, times: ["08:30", "16:30", "00:30"] },
            { name: "Phase 5b", perDay: 4, days: 2, times: ["08:30", "13:50", "19:10", "00:30"] },
            { name: "Phase 6", perDay: 2, days: 10, times: ["08:30", "16:30"] },
            { name: "Phase 7", perDay: 2, days: 10, times: ["08:30", "16:30"] },
            { name: "Phase 8", perDay: 1, days: 20, times: ["08:45"] }
        ];

        const motivationalQuotes = [
            "Every cigarette you don't smoke is a victory!",
            "You're stronger than your cravings!",
            "Your lungs are thanking you right now!",
            "Day by day, you're becoming healthier!",
            "Freedom is closer than you think!",
            "You're doing amazing! Keep going!",
            "Your future self will thank you!",
            "Breathe easier, live better!",
            "Champions are made in moments like these!",
            "Your body is healing with every hour that passes!"
        ];

        const notificationMessages = {
            fiveMinWarning: [
                "‚è∞ Heads up! Your next smoke break is in 5 minutes",
                "üïê 5 minutes until your scheduled cigarette",
                "‚è±Ô∏è Almost time! Get ready in 5 minutes",
                "üîî Your next one is coming up in 5 minutes",
                "‚åõ 5 minutes to go before your next cigarette"
            ],
            timeToSmoke: [
                "üö¨ It's time! Light it up according to schedule",
                "‚ú® Time for your scheduled cigarette",
                "üî• Your smoking time is now - stick to the plan!",
                "‚è∞ Right on schedule - time for one cigarette",
                "üìÖ Scheduled smoke break - let's go!"
            ],
            motivational: [
                "üí™ You're crushing it! Stay disciplined!",
                "üåü Every cigarette on schedule is progress!",
                "üéØ Discipline today, freedom tomorrow!",
                "‚ö° You're rewriting your habits, one day at a time!",
                "üèÜ Winners stay on schedule - that's you!"
            ],
            witty: [
                "ü§î Remember: You're the boss, not the cigarette",
                "üß† Your brain is learning new patterns - awesome!",
                "üí∞ Cha-ching! You're literally saving money right now",
                "üéÆ Achievement Unlocked: Another day on track!",
                "üî¨ Science fact: You're 24hrs closer to better lungs!"
            ]
        };

        let state = {
            startDate: null,
            currentDay: 1,
            todaySmoked: 0,
            totalSmoked: 0,
            totalCost: 39,
            packsUsed: 1,
            cigarettesInCurrentPack: 20,
            packPrice: 39,
            cigarettesPerPack: 20,
            phases: JSON.parse(JSON.stringify(defaultPhases)),
            lastNotificationTime: null,
            lastFiveMinWarning: null,
            lastResetDate: null,
            dailyHistory: {} // Store cigarettes per day: { "2025-01-15": 5, "2025-01-16": 8 }
        };

        // PWA Manifest
        const manifestData = {
            name: "Smoke Less - Your Reduction Journey",
            short_name: "Smoke Less",
            description: "Track your cigarette reduction journey",
            start_url: window.location.href,
            display: "standalone",
            background_color: "#0f172a",
            theme_color: "#0f172a",
            orientation: "portrait",
            icons: [
                {
                    src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Ccircle fill='%23667eea' cx='96' cy='96' r='96'/%3E%3Ctext x='96' y='130' font-size='100' text-anchor='middle'%3Eüö≠%3C/text%3E%3C/svg%3E",
                    sizes: "192x192",
                    type: "image/svg+xml",
                    purpose: "any maskable"
                },
                {
                    src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Ccircle fill='%23667eea' cx='256' cy='256' r='256'/%3E%3Ctext x='256' y='350' font-size='280' text-anchor='middle'%3Eüö≠%3C/text%3E%3C/svg%3E",
                    sizes: "512x512",
                    type: "image/svg+xml",
                    purpose: "any maskable"
                }
            ]
        };

        const manifestBlob = new Blob([JSON.stringify(manifestData)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.getElementById('manifest-link').setAttribute('href', manifestURL);

        // Service Worker Registration - Create inline service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Create service worker as a data URL instead of blob
                const swContent = `
                    self.addEventListener('install', (event) => {
                        self.skipWaiting();
                    });

                    self.addEventListener('activate', (event) => {
                        event.waitUntil(clients.claim());
                    });

                    self.addEventListener('notificationclick', (event) => {
                        event.notification.close();
                        event.waitUntil(
                            clients.matchAll({ type: 'window', includeUncontrolled: true }).then(clientList => {
                                for (let client of clientList) {
                                    if ('focus' in client) {
                                        return client.focus();
                                    }
                                }
                                if (clients.openWindow) {
                                    return clients.openWindow('/');
                                }
                            })
                        );
                    });
                `;

                // For GitHub Pages, we need to create a physical service worker file
                // Since we can't do that from here, we'll skip SW registration
                // Notifications will still work without service worker
                console.log('Service Worker: Using direct notifications (no SW needed for this app)');
            });
        }

        // PWA Installation
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').style.display = 'block';
        });

        window.addEventListener('appinstalled', () => {
            document.getElementById('installPrompt').style.display = 'none';
        });

        function installApp() {
            const installPrompt = document.getElementById('installPrompt');

            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        installPrompt.style.display = 'none';
                    }
                    deferredPrompt = null;
                });
            } else {
                // For browsers that don't support install prompt
                alert('üì± To install:\n\n' +
                    'Chrome: Menu ‚Üí "Add to Home screen"\n' +
                    'Safari: Share ‚Üí "Add to Home Screen"\n' +
                    'Firefox: Menu ‚Üí "Install"');
            }
        }

        function toggleMenu() {
            const menu = document.getElementById('sideMenu');
            const overlay = document.getElementById('menuOverlay');
            const hamburger = document.getElementById('hamburgerBtn');

            menu.classList.toggle('active');
            overlay.classList.toggle('active');
            hamburger.classList.toggle('active');
        }

        function initializeApp() {
            const saved = localStorage.getItem('smokeLessState');
            if (saved) {
                state = JSON.parse(saved);
                if (!state.startDate) state.startDate = new Date().toISOString();
                if (!state.packPrice) state.packPrice = 39;
                if (!state.cigarettesPerPack) state.cigarettesPerPack = 20;
                if (!state.phases) state.phases = JSON.parse(JSON.stringify(defaultPhases));
                if (!state.lastResetDate) state.lastResetDate = new Date().toISOString();
                if (!state.dailyHistory) state.dailyHistory = {};
            } else {
                state.startDate = new Date().toISOString();
                state.lastResetDate = new Date().toISOString();
                state.dailyHistory = {};
                saveState();
            }

            // Initialize audio for notification sounds
            initAudio();

            // Request wake lock to keep app active
            requestWakeLock();

            // CRITICAL: Check if day has changed and reset daily counter FIRST
            checkAndResetDailyCounter();

            // Then calculate current day
            calculateCurrentDay();

            // Update UI
            updateUI();
            checkNotificationPermission();

            // Clear any existing intervals
            if (countdownInterval) clearInterval(countdownInterval);
            if (notificationCheckInterval) clearInterval(notificationCheckInterval);

            // Start countdown update every second
            countdownInterval = setInterval(updateCountdown, 1000);

            // Check for notifications every 10 seconds (more aggressive)
            notificationCheckInterval = setInterval(checkAndSendNotifications, 10000);
            checkAndSendNotifications(); // Check immediately

            // Update motivational quote every 30 seconds
            setInterval(updateMotivationalQuote, 30000);

            // Check for day reset every 30 seconds (more frequent)
            setInterval(checkAndResetDailyCounter, 30000);

            // Keep app alive - ping every 5 seconds
            setInterval(() => {
                const now = new Date();
                console.log('App active:', now.toLocaleTimeString(), '| Today:', getTodayKey(), '| Smoked:', state.todaySmoked);
            }, 5000);
        }

        function getTodayKey() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        }

        function checkAndResetDailyCounter() {
            const todayKey = getTodayKey();
            const now = new Date();
            const lastReset = new Date(state.lastResetDate);

            // Check if it's a new day (compare dates only)
            const nowDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const lastResetDate = new Date(lastReset.getFullYear(), lastReset.getMonth(), lastReset.getDate());

            if (nowDate > lastResetDate) {
                console.log('üîÑ NEW DAY DETECTED - Resetting everything');
                console.log('Last reset:', lastResetDate.toLocaleDateString());
                console.log('Current date:', nowDate.toLocaleDateString());

                // Save yesterday's count to history before resetting
                const yesterdayKey = state.lastResetDate ?
                    new Date(state.lastResetDate).toISOString().slice(0, 10) : null;

                if (yesterdayKey && state.todaySmoked > 0) {
                    state.dailyHistory[yesterdayKey] = state.todaySmoked;
                    console.log(`Saved ${state.todaySmoked} cigarettes for ${yesterdayKey}`);
                }

                // Reset today's counter
                state.todaySmoked = 0;
                state.lastResetDate = now.toISOString();
                state.lastNotificationTime = null;
                state.lastFiveMinWarning = null;

                // Also recalculate current day
                calculateCurrentDay();

                saveState();
                updateUI();

                console.log('‚úÖ Day reset complete. New day:', state.currentDay, 'Today smoked:', state.todaySmoked);

                // Show notification that day has reset
                if ('Notification' in window && Notification.permission === 'granted') {
                    const phase = getCurrentPhase();
                    sendAggressiveNotification(
                        "üåÖ New Day Started!",
                        `Day ${state.currentDay}/62 - Goal: ${phase.perDay} cigarettes today`,
                        true
                    );
                }
            }
        }

        function calculateCurrentDay() {
            const start = new Date(state.startDate);
            start.setHours(0, 0, 0, 0);
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            const diffTime = now - start;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            state.currentDay = Math.max(1, Math.min(diffDays + 1, 62));
        }

        function getCurrentPhase() {
            let totalDays = 0;
            for (let phase of state.phases) {
                totalDays += phase.days;
                if (state.currentDay <= totalDays) {
                    return phase;
                }
            }
            return state.phases[state.phases.length - 1];
        }

        function updateUI() {
            const phase = getCurrentPhase();

            document.getElementById('dayNumber').textContent = state.currentDay;
            const progressCircle = document.getElementById('progressCircle');
            const circumference = 2 * Math.PI * 90;
            const progress = (state.currentDay / 62) * circumference;
            progressCircle.style.strokeDasharray = circumference;
            progressCircle.style.strokeDashoffset = circumference - progress;

            document.getElementById('phaseTitle').textContent = `${phase.name}: ${phase.perDay} per day`;
            document.getElementById('phaseDesc').textContent = `You're smoking ${phase.perDay} cigarette${phase.perDay > 1 ? 's' : ''} per day. Stay strong!`;

            document.getElementById('todayCount').textContent = `${state.todaySmoked}/${phase.perDay}`;
            document.getElementById('totalCost').textContent = `${state.totalCost} DH`;

            // Calculate money saved - can go negative if over limit
            const plannedSmoked = (state.currentDay - 1) * 10; // What you would have smoked at 10/day
            const actualSmoked = state.totalSmoked;
            const cigarettesAvoided = plannedSmoked - actualSmoked;
            const savedMoney = cigarettesAvoided * (state.packPrice / state.cigarettesPerPack);

            const savedMoneyEl = document.getElementById('savedMoney');
            savedMoneyEl.textContent = `${Math.round(savedMoney)} DH`;

            // Only color the text, not the box - use inline style for text color
            const savedMoneyValue = savedMoneyEl;
            if (savedMoney < 0) {
                savedMoneyValue.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                savedMoneyValue.style.webkitBackgroundClip = 'text';
                savedMoneyValue.style.webkitTextFillColor = 'transparent';
                savedMoneyValue.style.backgroundClip = 'text';
            } else if (savedMoney > 0) {
                savedMoneyValue.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                savedMoneyValue.style.webkitBackgroundClip = 'text';
                savedMoneyValue.style.webkitTextFillColor = 'transparent';
                savedMoneyValue.style.backgroundClip = 'text';
            } else {
                savedMoneyValue.style.background = 'linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%)';
                savedMoneyValue.style.webkitBackgroundClip = 'text';
                savedMoneyValue.style.webkitTextFillColor = 'transparent';
                savedMoneyValue.style.backgroundClip = 'text';
            }

            document.getElementById('totalSmoked').textContent = state.totalSmoked;

            updateSchedule(phase);
            updateNextSmoke(phase);
        }

        function updateSchedule(phase) {
            const list = document.getElementById('scheduleList');
            list.innerHTML = '';

            const now = new Date();
            let nextFound = false;

            phase.times.forEach((time, index) => {
                const item = document.createElement('div');
                item.className = 'schedule-item';

                const [hours, minutes] = time.split(':');
                const scheduleTime = new Date();
                scheduleTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);

                // Mark as completed based on today's smoked count (not time)
                if (index < state.todaySmoked) {
                    item.classList.add('completed');
                } else if (!nextFound) {
                    // Only mark as current if it's upcoming and not yet smoked
                    if (index === state.todaySmoked) {
                        item.classList.add('current');
                        nextFound = true;
                    }
                }

                item.innerHTML = `
                    <span class="schedule-time">${time}</span>
                    <span>${index < state.todaySmoked ? '‚úì' : '‚ö™'}</span>
                `;
                list.appendChild(item);
            });
        }

        function getNextSmokeTime(phase) {
            const now = new Date();

            for (let time of phase.times) {
                const [hours, minutes] = time.split(':');
                const scheduleTime = new Date();
                scheduleTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);

                if (scheduleTime > now) {
                    return scheduleTime;
                }
            }

            const [hours, minutes] = phase.times[0].split(':');
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            return tomorrow;
        }

        function updateNextSmoke(phase) {
            const nextTime = getNextSmokeTime(phase);
            const hours = nextTime.getHours().toString().padStart(2, '0');
            const minutes = nextTime.getMinutes().toString().padStart(2, '0');
            document.getElementById('nextTime').textContent = `${hours}:${minutes}`;
        }

        function updateCountdown() {
            const phase = getCurrentPhase();
            const nextTime = getNextSmokeTime(phase);
            const now = new Date();
            const diff = nextTime - now;

            if (diff < 0) {
                updateUI();
                return;
            }

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
            document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
            document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');
        }

        function checkAndSendNotifications() {
            const phase = getCurrentPhase();
            const nextTime = getNextSmokeTime(phase);
            const now = new Date();
            const diff = nextTime - now;
            const diffMinutes = Math.floor(diff / (1000 * 60));
            const diffSeconds = Math.floor(diff / 1000);

            // 5 minute warning - check range from 4:30 to 5:30 minutes
            if (diffMinutes === 4 || diffMinutes === 5) {
                const timeKey = nextTime.toISOString().slice(0, 16) + '-5min';
                if (state.lastFiveMinWarning !== timeKey) {
                    const messages = notificationMessages.fiveMinWarning;
                    const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                    sendAggressiveNotification(randomMessage, "Get ready to stay on track!", true);
                    state.lastFiveMinWarning = timeKey;
                    saveState();
                }
            }

            // Exact time notification - check 60 second window
            if (diffSeconds >= -30 && diffSeconds <= 60) {
                const timeKey = nextTime.toISOString().slice(0, 16);
                if (state.lastNotificationTime !== timeKey) {
                    const messages = notificationMessages.timeToSmoke;
                    const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                    sendAggressiveNotification(randomMessage, "Following the plan = winning the game!", false);
                    state.lastNotificationTime = timeKey;
                    saveState();
                }
            }
        }

        function sendAggressiveNotification(title, body, is5Min) {
            console.log('üîî Sending notification:', title);

            // Play sound immediately
            playNotificationSound();

            // Vibrate if supported
            if ('vibrate' in navigator) {
                navigator.vibrate([300, 100, 300, 100, 300, 100, 300]);
            }

            // Send multiple notifications for redundancy
            if ('Notification' in window && Notification.permission === 'granted') {
                const options = {
                    body: body,
                    icon: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Ccircle fill="%23667eea" cx="50" cy="50" r="50"/%3E%3Ctext x="50" y="70" font-size="60" text-anchor="middle"%3Eüö≠%3C/text%3E%3C/svg%3E',
                    badge: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Ccircle fill="%23667eea" cx="50" cy="50" r="50"/%3E%3Ctext x="50" y="70" font-size="60" text-anchor="middle"%3Eüö≠%3C/text%3E%3C/svg%3E',
                    vibrate: [300, 100, 300, 100, 300, 100, 300],
                    tag: is5Min ? 'smoke-5min' : 'smoke-now',
                    requireInteraction: !is5Min, // Require interaction for exact time
                    silent: false,
                    timestamp: Date.now(),
                    renotify: true
                };

                try {
                    // Send notification
                    const notification = new Notification(title, options);

                    notification.onclick = () => {
                        window.focus();
                        notification.close();
                    };

                    // Send a second notification after 2 seconds as backup
                    if (!is5Min) {
                        setTimeout(() => {
                            const backup = new Notification('üö¨ REMINDER: ' + title, {
                                ...options,
                                tag: 'smoke-now-backup'
                            });
                            backup.onclick = () => {
                                window.focus();
                                backup.close();
                            };
                        }, 2000);
                    }

                    // Play sound again after 3 seconds
                    setTimeout(() => playNotificationSound(), 3000);

                } catch (error) {
                    console.error('Notification error:', error);
                    // Fallback to alert if notification fails
                    if (!is5Min) {
                        alert('üö¨ ' + title + '\n\n' + body);
                    }
                }
            } else {
                // No notification permission - use alert as fallback
                if (!is5Min) {
                    alert('üö¨ ' + title + '\n\n' + body);
                }
            }

            // Flash the page title
            flashPageTitle(title);
        }

        function flashPageTitle(message) {
            const originalTitle = document.title;
            let count = 0;
            const interval = setInterval(() => {
                document.title = count % 2 === 0 ? 'üö¨ ' + message : originalTitle;
                count++;
                if (count > 10) {
                    clearInterval(interval);
                    document.title = originalTitle;
                }
            }, 500);
        }

        function markSmoked() {
            const phase = getCurrentPhase();
            const todayKey = getTodayKey();

            // Ensure we're using today's count only
            console.log('Marking smoked - Today:', todayKey, 'Current count:', state.todaySmoked);

            // Check if over limit - only warn, don't prevent
            if (state.todaySmoked >= phase.perDay) {
                const wittyMessages = [
                    "‚ö†Ô∏è Over your limit! But you're the boss - logging it anyway.\nMoney saved will go negative! üí∏",
                    "üö® Beyond today's quota! Still tracking it.\nYour savings are taking a hit! üìâ",
                    "‚ö†Ô∏è Exceeding the plan! Logged.\nRemember: Extra cigarettes = less savings! üí∞",
                    "üî¥ Over limit! But we're tracking everything.\nYour progress is affected! üìä",
                    "‚ö†Ô∏è Above schedule! Logging it anyway.\nThis impacts your financial goals! üíµ"
                ];
                const randomMsg = wittyMessages[Math.floor(Math.random() * wittyMessages.length)];

                // Show warning but continue
                if (confirm(randomMsg + "\n\nContinue logging this cigarette?")) {
                    // Continue to log
                } else {
                    return; // User cancelled
                }
            }

            // Increment today's count
            state.todaySmoked++;
            state.totalSmoked++;
            state.cigarettesInCurrentPack--;

            // Update daily history for today
            state.dailyHistory[todayKey] = state.todaySmoked;

            if (state.cigarettesInCurrentPack <= 0) {
                state.packsUsed++;
                state.totalCost += state.packPrice;
                state.cigarettesInCurrentPack = state.cigarettesPerPack;
            }

            console.log('After logging - Today smoked:', state.todaySmoked, 'Total:', state.totalSmoked);

            saveState();
            updateUI();

            const btn = event.target;
            const originalText = btn.textContent;

            let successMessage;
            if (state.todaySmoked <= phase.perDay) {
                const successMessages = [
                    '‚úì Logged! You\'re on track! üéØ',
                    '‚úì Logged! Discipline wins! üí™',
                    '‚úì Perfect! Staying scheduled! ‚≠ê',
                    '‚úì Boom! Another one tracked! üî•',
                    '‚úì Logged! You\'re crushing it! üèÜ'
                ];
                successMessage = successMessages[Math.floor(Math.random() * successMessages.length)];
                btn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            } else {
                successMessage = '‚ö†Ô∏è Logged (Over Limit)';
                btn.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
            }

            btn.textContent = successMessage;

            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '';
            }, 2000);
        }

        function updateMotivationalQuote() {
            const allQuotes = [
                ...motivationalQuotes,
                ...notificationMessages.motivational,
                ...notificationMessages.witty
            ];
            const quote = allQuotes[Math.floor(Math.random() * allQuotes.length)];
            const quoteEl = document.getElementById('motivationalText');
            quoteEl.style.opacity = '0';
            quoteEl.style.transition = 'opacity 0.3s ease';
            setTimeout(() => {
                quoteEl.textContent = quote;
                quoteEl.style.opacity = '1';
            }, 300);
        }

        function saveState() {
            localStorage.setItem('smokeLessState', JSON.stringify(state));
        }

        function checkNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                document.getElementById('notificationPrompt').style.display = 'block';
            }
        }

        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        document.getElementById('notificationPrompt').style.display = 'none';

                        // Initialize audio context on user interaction
                        initAudio();

                        // Request wake lock
                        requestWakeLock();

                        sendAggressiveNotification("üéâ Awesome! Notifications Enabled", "You'll get reminders with sound and vibration", true);

                        // Show Redmi-specific instructions
                        setTimeout(() => {
                            alert('üì± IMPORTANT for Redmi/MIUI users:\n\n' +
                                '1. Go to Settings ‚Üí Battery & Performance\n' +
                                '2. Find this browser (Chrome/Brave)\n' +
                                '3. Set to "No restrictions"\n' +
                                '4. Enable "Autostart"\n' +
                                '5. Lock this app in Recent Apps (üîí icon)\n\n' +
                                '6. Settings ‚Üí Notifications\n' +
                                '7. Find browser ‚Üí Enable all permissions\n' +
                                '8. Set priority to "Urgent"\n\n' +
                                'This ensures notifications work reliably!');
                        }, 2000);

                    } else if (permission === 'denied') {
                        alert('‚ö†Ô∏è Notifications blocked!\n\n' +
                            'Please enable notifications:\n' +
                            '1. Tap the lock/info icon in address bar\n' +
                            '2. Enable Notifications\n' +
                            '3. Reload the page');
                    }
                });
            }
        }

        function openSettings() {
            toggleMenu();
            document.getElementById('packPriceInput').value = state.packPrice;
            document.getElementById('cigarettesPerPackInput').value = state.cigarettesPerPack;
            document.getElementById('settingsModal').classList.add('active');
        }

        function openScheduleEditor() {
            toggleMenu();
            renderPhaseSelector();
            renderScheduleEditor(currentEditingPhase);
            document.getElementById('scheduleModal').classList.add('active');
        }

        function openDayPicker() {
            toggleMenu();
            document.getElementById('currentDayDisplay').textContent = state.currentDay;
            document.getElementById('dayNumberInput').value = state.currentDay;

            // Populate phase selector
            const phaseSelect = document.getElementById('phaseSelectInput');
            phaseSelect.innerHTML = '';
            state.phases.forEach((phase, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${phase.name} (${phase.perDay}/day for ${phase.days} days)`;
                phaseSelect.appendChild(option);
            });

            // Set current phase
            const currentPhaseIndex = getCurrentPhaseIndex();
            phaseSelect.value = currentPhaseIndex;
            updatePhaseDayInput();

            phaseSelect.onchange = updatePhaseDayInput;

            // Show day input by default
            showDayInput();

            document.getElementById('dayPickerModal').classList.add('active');
        }

        function showDayInput() {
            document.getElementById('dayInputSection').style.display = 'block';
            document.getElementById('phaseInputSection').style.display = 'none';
        }

        function showPhaseInput() {
            document.getElementById('dayInputSection').style.display = 'none';
            document.getElementById('phaseInputSection').style.display = 'block';
        }

        function getCurrentPhaseIndex() {
            let totalDays = 0;
            for (let i = 0; i < state.phases.length; i++) {
                totalDays += state.phases[i].days;
                if (state.currentDay <= totalDays) {
                    return i;
                }
            }
            return state.phases.length - 1;
        }

        function updatePhaseDayInput() {
            const phaseIndex = parseInt(document.getElementById('phaseSelectInput').value);
            const phase = state.phases[phaseIndex];
            document.getElementById('phaseDurationDisplay').textContent = phase.days;
            document.getElementById('phasesDayInput').max = phase.days;
            document.getElementById('phasesDayInput').value = 1;
        }

        function jumpToSelectedDay() {
            let targetDay;

            if (document.getElementById('dayInputSection').style.display !== 'none') {
                // By day number
                targetDay = parseInt(document.getElementById('dayNumberInput').value);
                if (targetDay < 1 || targetDay > 62) {
                    alert('‚ùå Please enter a day between 1 and 62');
                    return;
                }
            } else {
                // By phase
                const phaseIndex = parseInt(document.getElementById('phaseSelectInput').value);
                const dayInPhase = parseInt(document.getElementById('phasesDayInput').value);
                const phase = state.phases[phaseIndex];

                if (dayInPhase < 1 || dayInPhase > phase.days) {
                    alert(`‚ùå Please enter a day between 1 and ${phase.days} for this phase`);
                    return;
                }

                // Calculate target day
                let daysBeforePhase = 0;
                for (let i = 0; i < phaseIndex; i++) {
                    daysBeforePhase += state.phases[i].days;
                }
                targetDay = daysBeforePhase + dayInPhase;
            }

            if (confirm(`üóìÔ∏è Jump to Day ${targetDay}?\n\nThis will adjust your start date to make today Day ${targetDay}.\nYour current progress (${state.todaySmoked} cigarettes today) will be preserved.`)) {
                // Calculate new start date
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const newStartDate = new Date(today);
                newStartDate.setDate(today.getDate() - (targetDay - 1));

                state.startDate = newStartDate.toISOString();
                state.currentDay = targetDay;

                saveState();
                calculateCurrentDay();
                updateUI();

                closeModal('dayPickerModal');

                const phase = getCurrentPhase();
                alert(`‚úÖ Jumped to Day ${targetDay}!\n\n${phase.name}: ${phase.perDay} cigarettes/day\n\nYour progress tracking continues from here.`);
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function saveSettings() {
            const newPrice = parseFloat(document.getElementById('packPriceInput').value);
            const newCigsPerPack = parseInt(document.getElementById('cigarettesPerPackInput').value);

            if (newPrice > 0) state.packPrice = newPrice;
            if (newCigsPerPack > 0) state.cigarettesPerPack = newCigsPerPack;

            saveState();
            updateUI();
            closeModal('settingsModal');
            alert('‚úì Settings saved successfully!');
        }

        function renderPhaseSelector() {
            const selector = document.getElementById('phaseSelector');
            selector.innerHTML = '';

            state.phases.forEach((phase, index) => {
                const btn = document.createElement('button');
                btn.textContent = phase.name;
                btn.className = index === currentEditingPhase ? 'active' : '';
                btn.onclick = () => {
                    currentEditingPhase = index;
                    renderPhaseSelector();
                    renderScheduleEditor(index);
                };
                selector.appendChild(btn);
            });
        }

        function renderScheduleEditor(phaseIndex) {
            const editor = document.getElementById('scheduleEditor');
            const phase = state.phases[phaseIndex];

            editor.innerHTML = `
                <h4 style="margin: 15px 0 10px 0; color: var(--primary);">${phase.name} Schedule (${phase.perDay}/day for ${phase.days} days)</h4>
            `;

            phase.times.forEach((time, index) => {
                const item = document.createElement('div');
                item.className = 'schedule-editor-item';
                item.innerHTML = `
                    <input type="time" value="${time}" onchange="updateScheduleTime(${phaseIndex}, ${index}, this.value)">
                    <button onclick="removeScheduleTime(${phaseIndex}, ${index})">‚úï</button>
                `;
                editor.appendChild(item);
            });

            const addBtn = document.createElement('button');
            addBtn.className = 'add-time-btn';
            addBtn.textContent = '+ Add Time';
            addBtn.onclick = () => addScheduleTime(phaseIndex);
            editor.appendChild(addBtn);
        }

        function updateScheduleTime(phaseIndex, timeIndex, newValue) {
            state.phases[phaseIndex].times[timeIndex] = newValue;
        }

        function removeScheduleTime(phaseIndex, timeIndex) {
            if (state.phases[phaseIndex].times.length > 1) {
                state.phases[phaseIndex].times.splice(timeIndex, 1);
                state.phases[phaseIndex].perDay = state.phases[phaseIndex].times.length;
                renderScheduleEditor(phaseIndex);
            } else {
                alert("You need at least one time in the schedule!");
            }
        }

        function addScheduleTime(phaseIndex) {
            state.phases[phaseIndex].times.push("12:00");
            state.phases[phaseIndex].perDay = state.phases[phaseIndex].times.length;
            renderScheduleEditor(phaseIndex);
        }

        function saveSchedules() {
            state.phases.forEach(phase => {
                phase.times.sort((a, b) => {
                    const [aH, aM] = a.split(':').map(Number);
                    const [bH, bM] = b.split(':').map(Number);
                    return (aH * 60 + aM) - (bH * 60 + bM);
                });
            });

            saveState();
            updateUI();
            closeModal('scheduleModal');
            alert('‚úì Schedules saved successfully!');
        }

        function showStats() {
            toggleMenu();
            const phase = getCurrentPhase();
            const plannedSmoked = (state.currentDay - 1) * 10;
            const actualSmoked = state.totalSmoked;
            const cigarettesAvoided = plannedSmoked - actualSmoked;
            const savedMoney = cigarettesAvoided * (state.packPrice / state.cigarettesPerPack);

            const statusEmoji = savedMoney >= 0 ? '‚úÖ' : '‚ö†Ô∏è';
            const statusText = savedMoney >= 0 ? 'On Track!' : 'Over Limit';

            // Show recent history
            const todayKey = getTodayKey();
            const historyText = Object.keys(state.dailyHistory)
                .sort()
                .slice(-5)
                .map(date => {
                    const count = state.dailyHistory[date];
                    const isToday = date === todayKey;
                    return `${isToday ? 'üìç ' : '  '}${date}: ${count} cigs`;
                })
                .join('\n');

            alert(`üìä Your Statistics\n\n` +
                `${statusEmoji} Status: ${statusText}\n\n` +
                `Day: ${state.currentDay}/62\n` +
                `Phase: ${phase.name}\n` +
                `Today (${todayKey}): ${state.todaySmoked}/${phase.perDay}\n` +
                `Total Smoked: ${state.totalSmoked}\n` +
                `Planned (10/day): ${plannedSmoked}\n` +
                `Difference: ${cigarettesAvoided >= 0 ? '+' : ''}${cigarettesAvoided}\n\n` +
                `üìÖ Recent History:\n${historyText || 'No history yet'}\n\n` +
                `Total Cost: ${state.totalCost} DH\n` +
                `Money Saved: ${Math.round(savedMoney)} DH ${savedMoney < 0 ? '(NEGATIVE!)' : ''}\n` +
                `Packs Used: ${state.packsUsed}`);
        }

        function resetProgress() {
            toggleMenu();
            if (confirm('‚ö†Ô∏è Are you sure? This will delete all your progress and cannot be undone!')) {
                if (confirm('Really sure? This action is permanent!')) {
                    localStorage.removeItem('smokeLessState');
                    location.reload();
                }
            }
        }

        function showHelp() {
            toggleMenu();
            alert(`‚ùì Help & Info\n\n` +
                `üö¨ Log each cigarette by tapping the green button\n\n` +
                `‚è∞ You'll get notifications with SOUND + VIBRATION:\n` +
                `   ‚Ä¢ 5 minutes before\n` +
                `   ‚Ä¢ At exact time\n\n` +
                `üì± For Redmi/MIUI phones:\n` +
                `   1. Battery & Performance ‚Üí No restrictions\n` +
                `   2. Enable Autostart for browser\n` +
                `   3. Lock app in Recent Apps\n` +
                `   4. Notifications ‚Üí Set to Urgent\n\n` +
                `üìÖ Edit schedules to customize your plan\n\n` +
                `üí∞ Track spending and savings in real-time\n\n` +
                `üîã Keep browser active with no battery restrictions\n\n` +
                `üì≤ Add to Home Screen for best experience`);
        }

        // Initialize app
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>

</html>