<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Smoke Less">
    <meta name="description" content="Track your cigarette reduction journey">
    <link rel="manifest" id="manifest-link">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle fill='%23667eea' cx='50' cy='50' r='50'/%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle'%3Eüö≠%3C/text%3E%3C/svg%3E">
    <title>Smoke Less Journey</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #5568d3;
            --secondary: #764ba2;
            --accent: #f093fb;
            --accent-end: #f5576c;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            
            --bg-start: #0f172a;
            --bg-end: #1e293b;
            --card-bg: rgba(255, 255, 255, 0.95);
            --card-border: rgba(255, 255, 255, 0.1);
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --header-bg: rgba(15, 23, 42, 0.8);
            --footer-bg: rgba(15, 23, 42, 0.8);
            
            --glow-primary: rgba(102, 126, 234, 0.5);
            --glow-accent: rgba(245, 87, 108, 0.5);
        }

        body.dark-mode {
            --bg-start: #0f172a;
            --bg-end: #1e1b4b;
            --card-bg: rgba(30, 41, 59, 0.95);
            --card-border: rgba(255, 255, 255, 0.1);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --header-bg: rgba(15, 23, 42, 0.95);
            --footer-bg: rgba(15, 23, 42, 0.95);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: var(--text-primary);
            padding-bottom: 80px;
            transition: all 0.3s ease;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--header-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 20px;
            text-align: center;
            z-index: 100;
            border-bottom: 1px solid var(--card-border);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            font-size: 1.5em;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
            filter: drop-shadow(0 0 20px var(--glow-primary));
        }

        .header p {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 70px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--card-bg);
            border: 2px solid var(--card-border);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-size: 1.3em;
            cursor: pointer;
            z-index: 101;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        .settings-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--card-bg);
            border: 2px solid var(--card-border);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-size: 1.3em;
            cursor: pointer;
            z-index: 101;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .settings-btn:active {
            transform: scale(0.95);
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 100px 20px 20px;
        }

        .card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--card-border);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        }

        .progress-ring {
            width: 200px;
            height: 200px;
            margin: 20px auto;
            position: relative;
            filter: drop-shadow(0 0 30px var(--glow-primary));
        }

        .progress-ring svg {
            transform: rotate(-90deg);
        }

        .progress-ring circle {
            fill: none;
            stroke-width: 12;
        }

        .progress-ring .bg {
            stroke: rgba(102, 126, 234, 0.2);
        }

        .progress-ring .progress {
            stroke: url(#gradient);
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
            filter: drop-shadow(0 0 10px var(--glow-primary));
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .progress-text .number {
            font-size: 3em;
            font-weight: bold;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .progress-text .label {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .countdown-timer {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .time-unit {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 20px;
            border-radius: 16px;
            min-width: 80px;
            box-shadow: 0 8px 20px var(--glow-primary);
            transition: all 0.3s ease;
        }

        .time-unit:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 30px var(--glow-primary);
        }

        .time-unit .number {
            font-size: 2.5em;
            font-weight: bold;
            display: block;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .time-unit .label {
            font-size: 0.8em;
            opacity: 0.9;
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .next-smoke {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-end) 100%);
            color: white;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 8px 25px var(--glow-accent);
            transition: all 0.3s ease;
        }

        .next-smoke:hover {
            transform: scale(1.02);
            box-shadow: 0 12px 35px var(--glow-accent);
        }

        .next-smoke h3 {
            font-size: 1.1em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.95;
        }

        .next-smoke .time {
            font-size: 3em;
            font-weight: bold;
            text-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .stat-box {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid var(--card-border);
            transition: all 0.3s ease;
        }

        .stat-box:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .stat-box .value {
            font-size: 2em;
            font-weight: bold;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-box .label {
            color: var(--text-secondary);
            margin-top: 8px;
            font-size: 0.85em;
        }

        .phase-info {
            background: linear-gradient(135deg, rgba(251, 146, 60, 0.15) 0%, rgba(249, 115, 22, 0.15) 100%);
            padding: 20px;
            border-radius: 16px;
            margin: 20px 0;
            border: 1px solid rgba(251, 146, 60, 0.3);
        }

        .phase-info h3 {
            color: var(--warning);
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .phase-info p {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .schedule-list {
            margin-top: 15px;
        }

        .schedule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            border-radius: 12px;
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
        }

        .schedule-item:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            transform: translateX(5px);
        }

        .schedule-item.completed {
            opacity: 0.6;
            border-left-color: var(--success);
        }

        .schedule-item.current {
            background: linear-gradient(135deg, rgba(245, 87, 108, 0.15) 0%, rgba(240, 147, 251, 0.15) 100%);
            border-left-color: var(--accent-end);
            box-shadow: 0 4px 15px var(--glow-accent);
        }

        .schedule-time {
            font-weight: bold;
            font-size: 1.1em;
            color: var(--primary);
        }

        .btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 16px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .btn-success:hover {
            box-shadow: 0 12px 35px rgba(16, 185, 129, 0.5);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .motivational {
            background: linear-gradient(135deg, rgba(168, 237, 234, 0.2) 0%, rgba(254, 214, 227, 0.2) 100%);
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            margin: 20px 0;
            border: 1px solid var(--card-border);
        }

        .motivational p {
            font-size: 1.15em;
            color: var(--text-primary);
            font-style: italic;
            line-height: 1.6;
        }

        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--footer-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 15px 20px;
            text-align: center;
            border-top: 1px solid var(--card-border);
            box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.3);
            z-index: 90;
        }

        .footer p {
            color: var(--text-secondary);
            font-size: 0.85em;
        }

        .notification-banner {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.4);
        }

        .notification-banner button {
            background: white;
            color: var(--warning);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .notification-banner button:active {
            transform: scale(0.95);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 200;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 24px;
            max-width: 500px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--card-border);
        }

        .modal-content h2 {
            margin-bottom: 25px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.8em;
        }

        .setting-group {
            margin: 25px 0;
        }

        .setting-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: var(--text-primary);
        }

        .setting-group input {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--card-border);
            border-radius: 12px;
            font-size: 1em;
            background: rgba(102, 126, 234, 0.05);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .setting-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 20px var(--glow-primary);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancel {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            border: 2px solid var(--danger);
        }

        .btn-save {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            box-shadow: 0 4px 15px var(--glow-primary);
        }

        .schedule-editor-item {
            display: flex;
            gap: 10px;
            margin: 12px 0;
            align-items: center;
        }

        .schedule-editor-item input {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--card-border);
            border-radius: 10px;
            background: rgba(102, 126, 234, 0.05);
            color: var(--text-primary);
        }

        .schedule-editor-item button {
            padding: 12px 16px;
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-time-btn {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .phase-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        .phase-selector button {
            padding: 10px 16px;
            border: 2px solid var(--primary);
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary);
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .phase-selector button.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            box-shadow: 0 4px 15px var(--glow-primary);
        }

        .install-prompt {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 8px 25px var(--glow-primary);
            display: none;
        }

        .install-prompt button {
            background: white;
            color: var(--primary);
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.3s ease;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px var(--glow-primary); }
            50% { box-shadow: 0 0 40px var(--glow-primary); }
        }

        .pulse-glow {
            animation: glow 2s infinite;
        }

        @media (max-width: 600px) {
            .time-unit {
                min-width: 70px;
                padding: 15px;
            }
            
            .time-unit .number {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üö≠ Smoke Less Journey</h1>
        <p>Your path to freedom starts here</p>
    </div>

    <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">üåì</button>
    <button class="settings-btn" onclick="openSettings()" aria-label="Settings">‚öôÔ∏è</button>

    <div class="container">
        <div id="installPrompt" class="install-prompt">
            <p><strong>üì± Install this app</strong></p>
            <p style="font-size: 0.9em; margin-top: 8px;">Get notifications and quick access from your home screen</p>
            <button onclick="installApp()">Install Now</button>
        </div>

        <div id="notificationPrompt" class="notification-banner" style="display: none;">
            <p><strong>üîî Enable Notifications</strong></p>
            <p style="font-size: 0.9em; margin-top: 8px;">Get reminders for your smoking schedule</p>
            <button onclick="requestNotificationPermission()">Enable Notifications</button>
        </div>

        <div class="card">
            <div class="progress-ring">
                <svg width="200" height="200">
                    <defs>
                        <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#f093fb;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle class="bg" cx="100" cy="100" r="90"></circle>
                    <circle class="progress" cx="100" cy="100" r="90" id="progressCircle"></circle>
                </svg>
                <div class="progress-text">
                    <div class="number" id="dayNumber">1</div>
                    <div class="label">Day of 62</div>
                </div>
            </div>

            <div class="next-smoke pulse-glow">
                <h3>Next Cigarette</h3>
                <div class="time" id="nextTime">08:30</div>
            </div>

            <div class="countdown-timer">
                <div class="time-unit">
                    <span class="number" id="hours">00</span>
                    <span class="label">Hours</span>
                </div>
                <div class="time-unit">
                    <span class="number" id="minutes">00</span>
                    <span class="label">Min</span>
                </div>
                <div class="time-unit">
                    <span class="number" id="seconds">00</span>
                    <span class="label">Sec</span>
                </div>
            </div>

            <button class="btn btn-success" onclick="markSmoked()">‚úì I Smoked This One</button>
        </div>

        <div class="card">
            <div class="stats">
                <div class="stat-box">
                    <div class="value" id="todayCount">0/10</div>
                    <div class="label">Today's Progress</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="totalCost">39 DH</div>
                    <div class="label">Total Spent</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="savedMoney">0 DH</div>
                    <div class="label">Money Saved</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="totalSmoked">0</div>
                    <div class="label">Total Smoked</div>
                </div>
            </div>
        </div>

        <div class="phase-info">
            <h3 id="phaseTitle">Phase 1: Starting Strong</h3>
            <p id="phaseDesc">10 cigarettes per day for 2 days. You're building discipline!</p>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 15px; color: var(--text-primary);">üìÖ Today's Schedule</h3>
            <div class="schedule-list" id="scheduleList"></div>
        </div>

        <div class="motivational">
            <p id="motivationalText">"Every cigarette you don't smoke is a victory!"</p>
        </div>
    </div>

    <div class="footer">
        <p>üí™ Stay strong ‚Ä¢ You're doing great ‚Ä¢ Keep going!</p>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h2>‚öôÔ∏è Settings</h2>
            
            <div class="setting-group">
                <label>üí∞ Pack Price (DH)</label>
                <input type="number" id="packPriceInput" value="39" min="1" step="0.5">
            </div>
            
            <div class="setting-group">
                <label>üö¨ Cigarettes per Pack</label>
                <input type="number" id="cigarettesPerPackInput" value="20" min="1">
            </div>

            <div class="setting-group">
                <label>üìÖ Edit Schedules</label>
                <div class="phase-selector" id="phaseSelector"></div>
                <div id="scheduleEditor"></div>
            </div>
            
            <div class="setting-group">
                <label>üîî Notifications</label>
                <button class="btn btn-primary" onclick="testNotification()">Test Notification</button>
            </div>

            <div class="setting-group">
                <label>üîÑ Reset Progress</label>
                <button class="btn btn-primary" onclick="resetProgress()" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">Reset All Data</button>
            </div>
            
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeSettings()">Cancel</button>
                <button class="btn-save" onclick="saveSettings()">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        let deferredPrompt;
        let currentEditingPhase = 0;

        const defaultPhases = [
            { name: "Phase 1", perDay: 10, days: 2, times: ["08:30", "10:06", "11:42", "13:18", "14:54", "16:30", "18:06", "19:42", "21:18", "22:54"] },
            { name: "Phase 2", perDay: 5, days: 4, times: ["08:30", "12:30", "16:30", "20:30", "00:30"] },
            { name: "Phase 3", perDay: 4, days: 5, times: ["08:30", "13:50", "19:10", "00:30"] },
            { name: "Phase 4", perDay: 4, days: 5, times: ["08:30", "13:50", "19:10", "00:30"] },
            { name: "Phase 5a", perDay: 3, days: 4, times: ["08:30", "16:30", "00:30"] },
            { name: "Phase 5b", perDay: 4, days: 2, times: ["08:30", "13:50", "19:10", "00:30"] },
            { name: "Phase 6", perDay: 2, days: 10, times: ["08:30", "16:30"] },
            { name: "Phase 7", perDay: 2, days: 10, times: ["08:30", "16:30"] },
            { name: "Phase 8", perDay: 1, days: 20, times: ["08:45"] }
        ];

        const motivationalQuotes = [
            "Every cigarette you don't smoke is a victory!",
            "You're stronger than your cravings!",
            "Your lungs are thanking you right now!",
            "Day by day, you're becoming healthier!",
            "Freedom is closer than you think!",
            "You're doing amazing! Keep going!",
            "Your future self will thank you!",
            "Breathe easier, live better!",
            "Champions are made in moments like these!",
            "Your body is healing with every hour that passes!"
        ];

        const notificationMessages = {
            fiveMinWarning: [
                "‚è∞ Heads up! Your next smoke break is in 5 minutes",
                "üïê 5 minutes until your scheduled cigarette",
                "‚è±Ô∏è Almost time! Get ready in 5 minutes",
                "üîî Your next one is coming up in 5 minutes",
                "‚åõ 5 minutes to go before your next cigarette"
            ],
            timeToSmoke: [
                "üö¨ It's time! Light it up according to schedule",
                "‚ú® Time for your scheduled cigarette",
                "üî• Your smoking time is now - stick to the plan!",
                "‚è∞ Right on schedule - time for one cigarette",
                "üìÖ Scheduled smoke break - let's go!"
            ],
            motivational: [
                "üí™ You're crushing it! Stay disciplined!",
                "üåü Every cigarette on schedule is progress!",
                "üéØ Discipline today, freedom tomorrow!",
                "‚ö° You're rewriting your habits, one day at a time!",
                "üèÜ Winners stay on schedule - that's you!"
            ],
            witty: [
                "ü§î Remember: You're the boss, not the cigarette",
                "üß† Your brain is learning new patterns - awesome!",
                "üí∞ Cha-ching! You're literally saving money right now",
                "üéÆ Achievement Unlocked: Another day on track!",
                "üî¨ Science fact: You're 24hrs closer to better lungs!"
            ],
            encouragement: [
                "üåà Each scheduled smoke is one step closer to freedom",
                "üíé You're building willpower like a muscle - stronger daily!",
                "üöÄ Future you is already celebrating this moment",
                "üé® You're painting a masterpiece of self-control",
                "‚≠ê Legendary! You're doing what many dream of doing"
            ]
        };

        let state = {
            startDate: null,
            currentDay: 1,
            todaySmoked: 0,
            totalSmoked: 0,
            totalCost: 39,
            packsUsed: 1,
            cigarettesInCurrentPack: 20,
            packPrice: 39,
            cigarettesPerPack: 20,
            phases: JSON.parse(JSON.stringify(defaultPhases)),
            lastNotificationTime: null,
            lastMotivationalNotification: null,
            darkMode: false
        };

        // PWA Manifest
        const manifestData = {
            name: "Smoke Less - Your Reduction Journey",
            short_name: "Smoke Less",
            description: "Track your cigarette reduction journey",
            start_url: window.location.href,
            display: "standalone",
            background_color: "#0f172a",
            theme_color: "#667eea",
            orientation: "portrait",
            icons: [
                {
                    src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Ccircle fill='%23667eea' cx='96' cy='96' r='96'/%3E%3Ctext x='96' y='130' font-size='100' text-anchor='middle'%3Eüö≠%3C/text%3E%3C/svg%3E",
                    sizes: "192x192",
                    type: "image/svg+xml",
                    purpose: "any maskable"
                },
                {
                    src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Ccircle fill='%23667eea' cx='256' cy='256' r='256'/%3E%3Ctext x='256' y='350' font-size='280' text-anchor='middle'%3Eüö≠%3C/text%3E%3C/svg%3E",
                    sizes: "512x512",
                    type: "image/svg+xml",
                    purpose: "any maskable"
                }
            ]
        };

        const manifestBlob = new Blob([JSON.stringify(manifestData)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.getElementById('manifest-link').setAttribute('href', manifestURL);

        // Service Worker
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'smoke-less-v1';
                
                self.addEventListener('install', (event) => {
                    self.skipWaiting();
                });

                self.addEventListener('activate', (event) => {
                    event.waitUntil(clients.claim());
                });

                self.addEventListener('notificationclick', (event) => {
                    event.notification.close();
                    event.waitUntil(
                        clients.matchAll({ type: 'window', includeUncontrolled: true }).then(clientList => {
                            for (let client of clientList) {
                                if ('focus' in client) {
                                    return client.focus();
                                }
                            }
                            if (clients.openWindow) {
                                return clients.openWindow(self.registration.scope);
                            }
                        })
                    );
                });

                self.addEventListener('push', (event) => {
                    const data = event.data ? event.data.json() : {};
                    const title = data.title || 'Smoke Less';
                    const options = {
                        body: data.body || 'Time for your scheduled cigarette',
                        icon: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Ccircle fill="%23667eea" cx="50" cy="50" r="50"/%3E%3Ctext x="50" y="70" font-size="60" text-anchor="middle"%3Eüö≠%3C/text%3E%3C/svg%3E',
                        badge: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Ccircle fill="%23667eea" cx="50" cy="50" r="50"/%3E%3Ctext x="50" y="70" font-size="60" text-anchor="middle"%3Eüö≠%3C/text%3E%3C/svg%3E',
                        vibrate: [200, 100, 200, 100, 200],
                        tag: 'smoke-reminder',
                        requireInteraction: false,
                        silent: false,
                        data: data
                    };
                    
                    event.waitUntil(
                        self.registration.showNotification(title, options)
                    );
                });

                self.addEventListener('notificationclose', (event) => {
                    console.log('Notification closed:', event.notification.tag);
                });
            `;
            
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swUrl).then((registration) => {
                console.log('Service Worker registered successfully');
                
                // Request persistent notification permission
                if ('Notification' in window && Notification.permission === 'granted') {
                    // Keep service worker alive
                    setInterval(() => {
                        if (registration.active) {
                            registration.active.postMessage({ type: 'keepalive' });
                        }
                    }, 20000);
                }
            }).catch((error) => {
                console.error('Service Worker registration failed:', error);
            });
        }

        // PWA Installation
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').style.display = 'block';
        });

        window.addEventListener('appinstalled', () => {
            document.getElementById('installPrompt').style.display = 'none';
            deferredPrompt = null;
        });

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        document.getElementById('installPrompt').style.display = 'none';
                    }
                    deferredPrompt = null;
                });
            }
        }

        function toggleTheme() {
            state.darkMode = !state.darkMode;
            document.body.classList.toggle('dark-mode', state.darkMode);
            saveState();
        }

        function initializeApp() {
            const saved = localStorage.getItem('smokeLessState');
            if (saved) {
                state = JSON.parse(saved);
                if (!state.startDate) {
                    state.startDate = new Date().toISOString();
                }
                if (!state.packPrice) state.packPrice = 39;
                if (!state.cigarettesPerPack) state.cigarettesPerPack = 20;
                if (!state.phases) state.phases = JSON.parse(JSON.stringify(defaultPhases));
                if (state.darkMode === undefined) state.darkMode = false;
            } else {
                state.startDate = new Date().toISOString();
                saveState();
            }

            document.body.classList.toggle('dark-mode', state.darkMode);
            calculateCurrentDay();
            updateUI();
            checkNotificationPermission();
            scheduleNextNotification();
            
            setInterval(updateCountdown, 1000);
            setInterval(() => updateMotivationalQuote(), 30000);
            setInterval(scheduleNextNotification, 60000);
        }

        function calculateCurrentDay() {
            const start = new Date(state.startDate);
            start.setHours(0, 0, 0, 0);
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            const diffTime = now - start;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            state.currentDay = diffDays + 1;
            
            if (state.currentDay > 62) state.currentDay = 62;
            if (state.currentDay < 1) state.currentDay = 1;
        }

        function getCurrentPhase() {
            let totalDays = 0;
            for (let phase of state.phases) {
                totalDays += phase.days;
                if (state.currentDay <= totalDays) {
                    return phase;
                }
            }
            return state.phases[state.phases.length - 1];
        }

        function updateUI() {
            const phase = getCurrentPhase();
            
            document.getElementById('dayNumber').textContent = state.currentDay;
            const progressCircle = document.getElementById('progressCircle');
            const circumference = 2 * Math.PI * 90;
            const progress = (state.currentDay / 62) * circumference;
            progressCircle.style.strokeDasharray = circumference;
            progressCircle.style.strokeDashoffset = circumference - progress;

            document.getElementById('phaseTitle').textContent = `${phase.name}: ${phase.perDay} per day`;
            document.getElementById('phaseDesc').textContent = `You're smoking ${phase.perDay} cigarette${phase.perDay > 1 ? 's' : ''} per day. Stay strong!`;

            document.getElementById('todayCount').textContent = `${state.todaySmoked}/${phase.perDay}`;
            document.getElementById('totalCost').textContent = `${state.totalCost} DH`;
            
            const savedMoney = (state.currentDay * 10 * (state.packPrice/state.cigarettesPerPack)) - (state.totalSmoked * (state.packPrice/state.cigarettesPerPack));
            document.getElementById('savedMoney').textContent = `${Math.round(savedMoney)} DH`;
            document.getElementById('totalSmoked').textContent = state.totalSmoked;

            updateSchedule(phase);
            updateNextSmoke(phase);
        }

        function updateSchedule(phase) {
            const list = document.getElementById('scheduleList');
            list.innerHTML = '';
            
            const now = new Date();
            let nextFound = false;

            phase.times.forEach((time, index) => {
                const item = document.createElement('div');
                item.className = 'schedule-item';
                
                const [hours, minutes] = time.split(':');
                const scheduleTime = new Date();
                scheduleTime.setHours(parseInt(hours), parseInt(minutes), 0);
                
                if (scheduleTime < now && index < state.todaySmoked) {
                    item.classList.add('completed');
                } else if (!nextFound && scheduleTime >= now) {
                    item.classList.add('current');
                    nextFound = true;
                }
                
                item.innerHTML = `
                    <span class="schedule-time">${time}</span>
                    <span>${index < state.todaySmoked ? '‚úì' : '‚ö™'}</span>
                `;
                list.appendChild(item);
            });
        }

        function getNextSmokeTime(phase) {
            const now = new Date();
            
            for (let time of phase.times) {
                const [hours, minutes] = time.split(':');
                const scheduleTime = new Date();
                scheduleTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                
                if (scheduleTime > now) {
                    return scheduleTime;
                }
            }
            
            const [hours, minutes] = phase.times[0].split(':');
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            return tomorrow;
        }

        function updateNextSmoke(phase) {
            const nextTime = getNextSmokeTime(phase);
            const hours = nextTime.getHours().toString().padStart(2, '0');
            const minutes = nextTime.getMinutes().toString().padStart(2, '0');
            document.getElementById('nextTime').textContent = `${hours}:${minutes}`;
        }

        function updateCountdown() {
            const phase = getCurrentPhase();
            const nextTime = getNextSmokeTime(phase);
            const now = new Date();
            const diff = nextTime - now;

            if (diff < 0) {
                updateUI();
                return;
            }

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
            document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
            document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');
        }

        function scheduleNextNotification() {
            const phase = getCurrentPhase();
            const nextTime = getNextSmokeTime(phase);
            const now = new Date();
            const diff = nextTime - now;

            // 5 minutes before notification
            const fiveMinsBefore = diff - (5 * 60 * 1000);
            
            if (fiveMinsBefore > 0 && fiveMinsBefore < 60000) {
                const timeStr = nextTime.toISOString();
                if (state.lastNotificationTime !== timeStr + '-5min') {
                    const messages = notificationMessages.fiveMinWarning;
                    const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                    sendNotification(randomMessage, "Get ready to stay on track!", 'warning');
                    state.lastNotificationTime = timeStr + '-5min';
                    saveState();
                }
            }
            
            // Exact time notification
            if (diff > 0 && diff < 60000) {
                const timeStr = nextTime.toISOString();
                if (state.lastNotificationTime !== timeStr) {
                    const messages = notificationMessages.timeToSmoke;
                    const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                    sendNotification(randomMessage, "Following the plan = winning the game!", 'primary');
                    state.lastNotificationTime = timeStr;
                    saveState();
                }
            }

            // Motivational notification every 2 hours if app is open
            const lastMotivational = state.lastMotivationalNotification || 0;
            const timeSinceMotivational = now - new Date(lastMotivational);
            if (timeSinceMotivational > 2 * 60 * 60 * 1000) {
                const allMotivational = [
                    ...notificationMessages.motivational,
                    ...notificationMessages.witty,
                    ...notificationMessages.encouragement
                ];
                const randomMessage = allMotivational[Math.floor(Math.random() * allMotivational.length)];
                sendNotification(randomMessage, "You're doing great! Keep it up!", 'motivational');
                state.lastMotivationalNotification = now.toISOString();
                saveState();
            }
        }

        function markSmoked() {
            const phase = getCurrentPhase();
            
            if (state.todaySmoked >= phase.perDay) {
                const wittyMessages = [
                    "Whoa there, champ! üõë You've hit today's limit. Your lungs will thank you!",
                    "Hold up! ‚úã That's your quota for today. Stay strong!",
                    "Nice try! üòÑ But you're done for today. Discipline = Freedom!",
                    "Today's limit reached! üéØ You're sticking to the plan like a boss!",
                    "Stop right there! üö¶ You've smoked your scheduled amount. Proud of you!"
                ];
                const randomMsg = wittyMessages[Math.floor(Math.random() * wittyMessages.length)];
                alert(randomMsg);
                return;
            }

            state.todaySmoked++;
            state.totalSmoked++;
            state.cigarettesInCurrentPack--;

            if (state.cigarettesInCurrentPack <= 0) {
                state.packsUsed++;
                state.totalCost += state.packPrice;
                state.cigarettesInCurrentPack = state.cigarettesPerPack;
            }

            saveState();
            updateUI();

            const btn = event.target;
            const originalText = btn.textContent;
            const successMessages = [
                '‚úì Logged! You\'re on track! üéØ',
                '‚úì Logged! Discipline wins! üí™',
                '‚úì Perfect! Staying scheduled! ‚≠ê',
                '‚úì Boom! Another one tracked! üî•',
                '‚úì Logged! You\'re crushing it! üèÜ'
            ];
            const randomSuccess = successMessages[Math.floor(Math.random() * successMessages.length)];
            
            btn.textContent = randomSuccess;
            btn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            
            // Send encouraging notification
            if (state.todaySmoked === Math.floor(phase.perDay / 2)) {
                const messages = notificationMessages.motivational;
                sendNotification(messages[Math.floor(Math.random() * messages.length)], "Halfway through today - you're unstoppable!", 'motivational');
            }
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '';
            }, 2000);
        }

        function updateMotivationalQuote() {
            const allQuotes = [
                ...motivationalQuotes,
                ...notificationMessages.motivational,
                ...notificationMessages.witty,
                ...notificationMessages.encouragement
            ];
            const quote = allQuotes[Math.floor(Math.random() * allQuotes.length)];
            const quoteEl = document.getElementById('motivationalText');
            quoteEl.style.opacity = '0';
            quoteEl.style.transition = 'opacity 0.3s ease';
            setTimeout(() => {
                quoteEl.textContent = quote;
                quoteEl.style.opacity = '1';
            }, 300);
        }

        function saveState() {
            localStorage.setItem('smokeLessState', JSON.stringify(state));
        }

        function checkNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                document.getElementById('notificationPrompt').style.display = 'block';
            }
        }

        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        document.getElementById('notificationPrompt').style.display = 'none';
                        const messages = notificationMessages.encouragement;
                        const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                        sendNotification("üéâ Awesome! Notifications Enabled", randomMessage, 'motivational');
                        
                        // Request persistent notification permission for background
                        if ('serviceWorker' in navigator && 'PushManager' in window) {
                            navigator.serviceWorker.ready.then((registration) => {
                                console.log('Push notifications ready');
                            });
                        }
                    } else if (permission === 'denied') {
                        alert('‚ö†Ô∏è Notifications blocked. Please enable them in your browser settings to get reminders.');
                    }
                });
            } else {
                alert('‚ùå Your browser does not support notifications.');
            }
        }

        function sendNotification(title, body, type = 'primary') {
            if ('Notification' in window && Notification.permission === 'granted') {
                const options = {
                    body: body,
                    icon: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Ccircle fill="%23667eea" cx="50" cy="50" r="50"/%3E%3Ctext x="50" y="70" font-size="60" text-anchor="middle"%3Eüö≠%3C/text%3E%3C/svg%3E',
                    badge: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Ccircle fill="%23667eea" cx="50" cy="50" r="50"/%3E%3Ctext x="50" y="70" font-size="60" text-anchor="middle"%3Eüö≠%3C/text%3E%3C/svg%3E',
                    vibrate: type === 'primary' ? [200, 100, 200, 100, 200] : [200, 100, 200],
                    tag: 'smoke-reminder-' + type,
                    requireInteraction: type === 'primary',
                    silent: false,
                    renotify: true,
                    data: { type: type, timestamp: Date.now() }
                };

                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.ready.then((registration) => {
                        registration.showNotification(title, options).catch(err => {
                            console.error('Notification error:', err);
                            // Fallback to regular notification
                            new Notification(title, options);
                        });
                    });
                } else {
                    new Notification(title, options);
                }

                // Also trigger push notification if supported
                if ('serviceWorker' in navigator && 'PushManager' in window) {
                    navigator.serviceWorker.ready.then((registration) => {
                        // Simulate push for local notifications
                        registration.active.postMessage({
                            type: 'push',
                            title: title,
                            body: body,
                            notificationType: type
                        });
                    });
                }
            }
        }

        function testNotification() {
            const allMessages = [
                ...notificationMessages.timeToSmoke,
                ...notificationMessages.motivational,
                ...notificationMessages.witty
            ];
            const randomMessage = allMessages[Math.floor(Math.random() * allMessages.length)];
            sendNotification(randomMessage, "Your notifications are working perfectly! üéâ", 'primary');
        }

        function openSettings() {
            document.getElementById('packPriceInput').value = state.packPrice;
            document.getElementById('cigarettesPerPackInput').value = state.cigarettesPerPack;
            renderPhaseSelector();
            renderScheduleEditor(currentEditingPhase);
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function renderPhaseSelector() {
            const selector = document.getElementById('phaseSelector');
            selector.innerHTML = '';
            
            state.phases.forEach((phase, index) => {
                const btn = document.createElement('button');
                btn.textContent = phase.name;
                btn.className = index === currentEditingPhase ? 'active' : '';
                btn.onclick = () => {
                    currentEditingPhase = index;
                    renderPhaseSelector();
                    renderScheduleEditor(index);
                };
                selector.appendChild(btn);
            });
        }

        function renderScheduleEditor(phaseIndex) {
            const editor = document.getElementById('scheduleEditor');
            const phase = state.phases[phaseIndex];
            
            editor.innerHTML = `
                <h4 style="margin: 15px 0 10px 0; color: var(--primary);">${phase.name} Schedule (${phase.perDay}/day for ${phase.days} days)</h4>
            `;
            
            phase.times.forEach((time, index) => {
                const item = document.createElement('div');
                item.className = 'schedule-editor-item';
                item.innerHTML = `
                    <input type="time" value="${time}" onchange="updateScheduleTime(${phaseIndex}, ${index}, this.value)">
                    <button onclick="removeScheduleTime(${phaseIndex}, ${index})">‚úï</button>
                `;
                editor.appendChild(item);
            });
            
            const addBtn = document.createElement('button');
            addBtn.className = 'add-time-btn';
            addBtn.textContent = '+ Add Time';
            addBtn.onclick = () => addScheduleTime(phaseIndex);
            editor.appendChild(addBtn);
        }

        function updateScheduleTime(phaseIndex, timeIndex, newValue) {
            state.phases[phaseIndex].times[timeIndex] = newValue;
        }

        function removeScheduleTime(phaseIndex, timeIndex) {
            if (state.phases[phaseIndex].times.length > 1) {
                state.phases[phaseIndex].times.splice(timeIndex, 1);
                state.phases[phaseIndex].perDay = state.phases[phaseIndex].times.length;
                renderScheduleEditor(phaseIndex);
            } else {
                alert("You need at least one time in the schedule!");
            }
        }

        function addScheduleTime(phaseIndex) {
            state.phases[phaseIndex].times.push("12:00");
            state.phases[phaseIndex].perDay = state.phases[phaseIndex].times.length;
            renderScheduleEditor(phaseIndex);
        }

        function saveSettings() {
            const newPrice = parseFloat(document.getElementById('packPriceInput').value);
            const newCigsPerPack = parseInt(document.getElementById('cigarettesPerPackInput').value);
            
            if (newPrice > 0) {
                state.packPrice = newPrice;
            }
            if (newCigsPerPack > 0) {
                state.cigarettesPerPack = newCigsPerPack;
            }
            
            state.phases.forEach(phase => {
                phase.times.sort((a, b) => {
                    const [aH, aM] = a.split(':').map(Number);
                    const [bH, bM] = b.split(':').map(Number);
                    return (aH * 60 + aM) - (bH * 60 + bM);
                });
            });
            
            saveState();
            updateUI();
            closeSettings();
            
            alert('‚úì Settings saved successfully!');
        }

        function resetProgress() {
            if (confirm('‚ö†Ô∏è Are you sure? This will delete all your progress and cannot be undone!')) {
                localStorage.removeItem('smokeLessState');
                location.reload();
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', initializeApp);
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>